# Проектирование высоконагружнных приложений

## Тема и целевая аудитория

Тема - "Проектирование сервиса по типу Google Drive"

Функционал (MVP) :
- загрузка файла
- удаление файла
- скачивание файла
- поиск по диску
- создание общей папки, файла
- история изменения папок, файлов

Целевая аудитория:
- 2.6B Посещений в месяц по всему миру
- 85.5M Посещений в день
- Среднее время визита 6 min
- Среднее количество страниц за визит 5
- Bounce Rate(Cредний процент посетителей, которые просматривают только одну страницу) - 29%
- Основные пользователи офисные сотрудники и студенты, возраст 20-40 лет
- Распредение по странам
  | Страна         | Процент от всех юзеров   |
  | -------------- | ------------------------ |
  | США            | ~25 %   |
  | Бразилия       | ~6 %    |
  | Индия          | ~4.5 %  |
  | Вьетнам        | ~3 %    |
  | Мексика        | ~3 %    |

Источники: [hypestat](https://hypestat.com/info/drive.google.com), [simularweb](https://www.similarweb.com/website/drive.google.com/#demographics)

## Расчет нагрузки

### Объем хранилища и типы файлов
В стандартном тарифном плане объем предоставлемого хранилища 15 гб для компаний и платных пользоватей 2тб. Платных пользоватей у Google drive 8mln. Вообщем пользоватей примерно 2.6bln. На основании собственного опыта и опроса знакомых диск в среднем заполнеy на 2/3. Примерно по пропорции можно закладывать 18GB в среднем на пользователя.

**Общий размер всего хранилища**: ```18GB * 2.6bln ~ 41_600PiB.```

По опросам пользователей, 80% используют диск только для видео и фото. Для простоты будем счиать что остальные файлы это документы. Поскольку основной алгоритм использования это загрузка на диск фото и видео с телефона для долгострочного хранения. Соотношение фото к видео у меня и знакомых на телефоне примерное 8:1, будем брать такую статистику в расчетах.

  | Тип файла         |Процент от всех файлов в штуках    |
  | -------------- | ------------ |
  | Фото           | 71 %        |
  | Видео          | 9 %         |
  | Документы      | 20 %       |


Оценим средний размер PNG картинки ```( 1920px * 1080 px * 4b + 33b (header) ) * 0.66 (среднее сжатие DEFLATE) ~= 5.12 MiB```. Также есть информация что средний размер фотографии на iPhone в 2023 году был 2-8mb, что примерно бьется с расчетами.
Продолжая ориентироватся что большая часть /фото видео снимается на iPhone возьмем средний размер 1080p/30fps видео снятого на последний - это ```60MiB/min```, средняя продолжительность видео на самом попярном видеохостинге ```11.7min```. Исходя из этого средний обьем видео:```60 * 11.7 = 700MiB```
Размер документа docx/pdf   ```10 kB + 3kB/page```, будем брать среднем 30KiB.
Итого:

  | Тип файла      |Средний размер  |
  | -------------- | -------------- |
  | Фото           | 5.12MiB        |
  | Видео          | 700MiB         |
  | Документы      | 30KiB          |



### Среднее количество действий пользователя день:

Приведем статистику которая есть от похожего сервиса - [Dropbox](ttps://marketsplash.com/dropbox-statistics/#link4).
 - 1.2bln загружаемых файлом в день при DAU 4mln, в пересчете 300 файлов в день на пользователя
 - 100k создаваемых ссылок на папки, файлы при DAU 4mln в пересчете 0.6 ссылок в день на пользователя
   

Просмотр файла также будем считать за скачивание, так как пользователь пользователь просматривая картинку/видео/документ его скачивает.
Пусть около 5% посещений происходит с запросом авторизации. Среднее количество посещаемых страниц равно 5, а поскольку на диске только папки являются страницами будем брать это как просмотр содержимого папки. Будем считать что просматривают пользователи в 2 раза больше чем загружают, к-во удалений тоже возьмем сравнимое с загрузкой.


| Действие    | Среднее количество дейстивий в день на пользователя |
| --------    | ------- |
| Авторизация    | 0.05 |
| Загрузка на диск | 300 |
|Просмотр/скачивание с диска| 600|
| Удаление | 100 |
|Создание ссылки| 0.6 |
| Просмотр директории | 5 |
| Поиск по диску | 5 |


### RPS
DAU = 85.5 M
RPS = количесво действий на пользователя * DAU / 86 400

Файлы будут загрузаться чанками по 10 MiB с клиента, чанкование возможно в основном только для видео в нашем случае это ```700/10 = 70``` запросов на загрузку видео. Количество загрузок видео ```300*9% =27```.

```RPS = DAU * (0.05 + 300*91% + 27 * 70 + 600 + 100 + 0.6 + 5 + 5) / 86400 = 2873.65 * DAU /86400 ~ 2_850_000```

Общее
- **RPS** ~ 2_850_000.
- **Пиковый RPS (x1.5)** ~ 4_250_000.

### Расчет сетевого траффика
DAU = 85.5 M


Скачивание будет производится с s3 так что посчитаем его отдельно. Все запросы не связанные с файлами будем счиать размером в 5KiB
**Общий трафик**
```Дневной трафик = DAU * sum(count*size) * 8```
```DAU * ((0.05+600+100+0.6 + 5 + 5) * 5KiB + 300*20%*30KiB + 27*700MiB + 300*71%*5.12MiB) * 8 = DAU * (3.47MiB + 1.76MiB + 18900MiB + 1090.56MiB) * 8 ~ 12_738 Pbit/day```
``` Трафик с секунду = 12_738 Pbit/day / 86400 = 151 Tbit/sec```
**Скачивание**
``` Скачивание в день = DAU * 600 * (0.2 * 30KiB + 0.09 * 700MiB + 0.71 * 5.12MiB) * 8 = 25_491 Pbit/day ```
``` Скачивание в секунду =  25_491 Pbit/day / 86400 = 302Tbit/sec```



### Технические метрики:
| Метрика    | Значение |
| -------- | ------- |
| Общий размер хранилища  | 41_600PiB |
| Траффик в день | 38230 Pbit/day |
| Пиковый траффик в секунду | 453 Tbit/s |
| RPS | 2_850_000 |
| Пиковый RPS | 4_250_000 |

##Глобальная балансировка
