# Проектирование высоконагружнных приложений

## Тема и целевая аудитория

Тема - "Проектирование сервиса по типу Google Drive"

Функционал (MVP) :
- загрузка файла
- удаление файла
- скачивание файла
- посмотр информации о файле
- поиск по диску
- разграниечение доступа(общий доступ к папкам)
- история изменения папок, файлов

Целевая аудитория:
- 2.6B Посещений в месяц по всему миру
- 85.5M Посещений в день
- Среднее время визита 6 min
- Среднее количество страниц за визит 5
- Bounce Rate(Cредний процент посетителей, которые просматривают только одну страницу) - 29%
- Основные пользователи офисные сотрудники и студенты, возраст 20-40 лет
- Распредение по странам
  | Страна         | Процент от всех юзеров   |
  | -------------- | ------------------------ |
  | США            | ~25 %   |
  | Бразилия       | ~6 %    |
  | Индия          | ~4.5 %  |
  | Вьетнам        | ~3 %    |
  | Мексика        | ~3 %    |

Источники: [hypestat](https://hypestat.com/info/drive.google.com), [simularweb](https://www.similarweb.com/website/drive.google.com/#demographics)

## Расчет нагрузки

### Объем хранилища и аудитория
В стандартном тарифном плане объем предоставлемого хранилища 15 гб для компаний и платных пользоватей 2тб. Платных пользоватей у Google drive 3mln. Вообщем пользоватей примерно 2.6bln. На основании собственного опыта и опроса знакомых диск в среднем заполне на 2/3. Учитывая что платных пользователей кратно меньше можно закладывать 10гб в среднем на пользователя.

По опросам пользоватей, 80% используют диск только для видео и фото.

Рассмотрим основные типы файлов

- **Средний размер PNG картинки**: ( 1920px * 1080 px * 4b + 33b (header) ) * 0.66 (среднее сжатие DEFLATE) ~= 5.12 MiB.
- **Средний размер видео**: 512 MiB.
- **Средний размер текстового файла**: 5 KiB.
- **Средний размер документа docx/pdf**: 2.5 MiB.


**Общий размер всего хранилища**: 10GB * 2.6bln ~ 23000PiB.

В будущем не будем учитывать текстовые файлы при расчетах, так как они занимают слишком мало пространства по сравнению с остальным контентом.

### Среднее количество действий пользователя день:

Просмотр файла также будем считать за скачивание, так как пользователь пользователь просматривая картинку/видео/документ его скачивает.

| Действие   | Среднее количество дейстивий |
| -------- | ------- |
| Скачивание видео | 2 в неделю |
| Скачивание png | 2 в день |
| Скачивание документов | 1 в день |
| Загрузка на диск видео | 2 в неделю |
| Загрузка на диск png | 5 в день |
| Загрузка на диск документов | 1 в день |
| Удаление | 1 в неделю |
| Просмотр директории | 3 в день |

### RPS
DAU = 5.5 M
RPD * DAU / 86 400

Скачивание
- **Скачивание видео**: 2/7 * DAU / 86 400 = 284.
- **Скачивание png**: 2 * DAU / 86 400 = 1990.
- **Скачивание документов**: 1 * DAU / 86 400 = 995.

Загрузка\
(Файлы будут загрузаться чанками по 10 MBi с клиента, поэтому любое действие загрузки будет домножать на среднее кол-во файлов объекта, чанкованию подвержены только видео.)
- **Загрузка на диск видео**: 2/7 * ( 512 / 10 )  * DAU / 86 400 ~ 14500.
- **Загрузка на диск jpg**: 4 * DAU / 86 400 = 3980.
- **Загрузка на диск документов**: 1 * DAU / 86 400 = 995.

Удаление
- **Удаление**: 1 * DAU / 86 400 = 995.

Просмотр
- **Просмотр директории***: 3 * DAU / 86 400 = 2986.

Общее
- **RPS** ~ 27700.
- **Пиковый RPS (x1.5)** ~ 41500.

### Расчет сетевого траффика
DAU = 85.5 M

Просмотр директории не будет критически влиять на сетевой траффик, так как на фоне загружаемых файлов это всего лишь несколько байт, поэтому мы не будем учитывать его при расчете сетевого траффика.\

#### Дневной траффик:
RPS * объем файлов, который требует дейcтвие * 86 400

- **Загрузка на диск**: (14500 * 10 MiB + 3980 * 5.12 MiB + 995 * 2.5 MiB) * 86 400 * 8 = 108 Pbit / day 
- **Дневной траффик**: 6 644 224 Gbit / day

